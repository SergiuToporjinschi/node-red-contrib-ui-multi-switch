<script type="text/html text/x-red" data-template-name="ui-multi-switch">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="config.label.name"></span></label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row" id="template-row-group">
        <label for="node-input-group"><i class="fa fa-table"></i> <span data-i18n="config.label.group"></span></label>
        <input type="text" id="node-input-group">
    </div>
    <div class="form-row" id="template-row-size">
        <label><i class="fa fa-object-group"></i> <span data-i18n="config.label.size"></span></label>
        <input type="hidden" id="node-input-width">
        <input type="hidden" id="node-input-height"> 
        <button class="editor-button" id="node-input-size"></button>
    </div>
    <div class="form-row">
        <label style="width:95%; border-bottom: 1px solid #eee;"><span data-i18n="config.label.addSection"></label>
    </div>
    <div class="ident"> 
    	<div class="form-row">
            <label for="add-controlKey"><i class="fa fa-list"></i> <span data-i18n="config.label.typeKey"></span></label>
            <input id="add-controlKey" type="text" style="width:73%">
            <input id="add-controlKey-value" type="hidden">
        </div>
        <div id="add-control-switch-sendOnOffValue">
            <div class="form-row">
                <label style="width:auto" for="add-control-switch-onvalue"><i class="fa fa-envelope-o"></i> <span data-i18n="config.label.sendSwitchOnOffLabel"></span></label>
            </div>
            <div class="form-row">
                <label for="add-control-switch-onvalue"><span data-i18n="config.label.sendSwitchOnLabel"></label>
                <input type="text" id="add-control-switch-onvalue" style="width:70%">
                <input type="hidden" id="add-control-switch-onvalue-value">
            </div>
            <div class="form-row">
                <label for="add-control-switch-offvalue"><span data-i18n="config.label.sendSwitchOffLabel"></label>
                <input type="text" id="add-control-switch-offvalue" style="width:70%">
                <input type="hidden" id="add-control-switch-offvalue-value">
            </div>
        </div>
        <div class="form-row">
            <label for="add-control-label"><i class="fa fa-list"></i> <span data-i18n="config.label.label"></span></label>
            <input id="add-control-label" type="text" style="width:73%">
        </div>
    </div>
    <div class="form-row">
        <label style="width:95%; border-bottom: 1px solid #eee;"><span data-i18n="config.label.controls"></label>
    </div>
    <div class="ident"> 
        <div class="form-row" id="template-row-size">
            <ol id="node-input-topics-container"></ol>
        </div>
    </div> 
    <!-- <div class="ident">
	</div> -->
	<!-- <div class="form-row">
    </div>
	<div class="ident"> --> 
		<!-- <div class="form-row" style="display: block;">
			<label style="width: 140px !important" for="node-input-thresholdRising"><i class="fa fa-level-up"/> <span data-i18n="ui_multi_switch.label.upThreshold"></label>
			<input type="number" id="node-input-thresholdRising" data-i18n="[placeholder]ui_multi_switch.placeholder.value" style="width: 280px" dir="">
		</div> -->
		<!-- <div class="form-row" style="display: block;">
			<label style="width: 140px !important" for="node-input-thresholdFalling"><i class="fa fa-level-down"/> <span data-i18n="ui_multi_switch.label.lowerThreshold"></label>
			<input type="number" id="node-input-thresholdFalling" data-i18n="[placeholder]ui_multi_switch.placeholder.value" style="width: 280px" dir="">
		</div> 
	</div>-->
	
</script>

<script type="text/javascript">
    RED.nodes.registerType("ui-multi-switch", {
        category: 'dashboard',
        color: 'rgb( 63, 173, 181)',
        defaults: {
            name: { value: 'Multi switch' },
            group: {
                type: 'ui_group', required: true,
                validate: function (v) {
                    debugger;
                    return v && RED.nodes.node(v) && RED.nodes.node(v).type === 'ui_group';
                }
            },
            order: { value: 0 },
            width: {
                value: 8,
                required: true,
                validate: function (v) {
                    var valid = true;
                    var width = v || 0;
                    var currentGroup = $('#node-input-group').val() || this.group;
                    var groupNode = RED.nodes.node(currentGroup);
                    valid = !groupNode || + width <= +groupNode.width;
                    $("#node-input-size").toggleClass("input-error", !valid);
                    return valid;
                }
            },
            height: { value: 3 },
        },
        inputs: 1,
        outputs: 1,
        align: "left",
        icon: "serial.png",
        paletteLabel: "Multi switch",
        label: function () { return this.name || "Multi switch"; },
        oneditprepare: function () {
            $("#add-controlKey").typedInput({
                types:
                    [{ value: "switch", label: RED._("node-red-contrib-ui-multi-switch/ui-multi-switch:config.label.switchType"), hasValue: true },
                    { value: "button", label: RED._("node-red-contrib-ui-multi-switch/ui-multi-switch:config.label.buttonType"), hasValue: true }]
            });

            $('#add-control-switch-offvalue').typedInput({
                default: 'bool',
                typeField: $("add-control-switch-offvalue-value"),
                types: ['str', 'num', 'bool', 'json', 'bin', 'date', 'flow', 'global'],
                value: true
            });
            $("#add-controlKey").on('change', function () {
                debugger;
                if ($("#add-controlKey").typedInput('type') === 'switch') {
                    $("#add-control-switch-sendOnOffValue").show();
                } else {
                    $("#add-control-switch-sendOnOffValue").hide();
                }
            });
            $('#add-control-switch-onvalue').typedInput({
                default: 'bool',
                typeField: $("#add-control-switch-onvalue-value"),
                types: ['str', 'num', 'bool', 'json', 'bin', 'date', 'flow', 'global'],
                value: false
            });

            $("#node-input-size").elementSizer({
                width: "#node-input-width",
                height: "#node-input-height",
                group: "#node-input-group"
            });
        },
        oneditsave: function () {
            // debugger
            // $("#node-input-calendar").val(this.editor.getValue());
            // this.editor.destroy();
            // delete this.editor;
            // this.sliderMaxValue = Number.parseFloat(this.sliderMaxValue);
            // this.sliderMinValue = Number.parseFloat(this.sliderMinValue);
            // this.sliderStep = Number.parseFloat(this.sliderStep)
            // this.thresholdFalling = Number.parseFloat(this.thresholdFalling);
            // this.thresholdRising = Number.parseFloat(this.thresholdRising);
        },
        oneditcancel: function () {
            // this.editor.destroy();
            // delete this.editor;
        },
        oneditresize: function (size) {
            // this.editor.resize();
        }
    });
</script>
<script type="text/html text/x-red" data-help-name="ui-multi-switch">
	<p>A dashboard ui interface node for controlling a heater;</p>
    <h3>Properties</h3>
    <dl class="message-properties">
		<dt>Min <span class="property-type">integer</span></dt>
		<dd>Minimum vale selectable using slider</dd>
    </dl>
	<dl class="message-properties">
		<dt>Max <span class="property-type">boolean</span></dt>
		<dd>Maximum vale selectable using slider</dd>
    </dl>
    <dl class="message-properties">
		<dt>Step <span class="property-type">integer</span></dt>
		<dd>Step value selectable from slider</dd>
    </dl>
    <dl class="message-properties">
        <dt>Upper threshold<span class="property-type">float</span></dt>
        <dd>Hysteresis upper threshold limit. This value is added to the target temperature to determinate the point of setting the heater to off</dd>
    </dl>
    <dl class="message-properties">
        <dt>Lower threshold<span class="property-type">float</span></dt>
        <dd>Hysteresis Lower threshold limit. This value is added to the target temperature to determinate the point of setting the heater to on</dd>
    </dl>
    <dl class="message-properties">
        <dt>Calendar<span class="property-type">json</span></dt>
        <dd>The calendar which will be apply in automatic mode. Needs to be a valid JSON with float values for temperature.<br>
            Is important to cover the entire interval of 24/7, otherwise will keep the temperature untill next sice or next week day</dd>
        <dd>For example:</dd>
        <pre>
{
    "Monday" : {
        "00:00" : 19,
        "06:20" : 22,
        "08:00" : 19,
        "16:40" : 22,
        "23:59" : 19
    },
    "Tuesday" : {
        "00:00" : 19,
        "06:20" : 22,
        "08:00" : 19,
        "16:40" : 22,
        "23:59" : 19
    }
}
        </pre>
    </dl>    
    <h3>Inputs</h3>
    <p>This controller accepts one main input which has to have topic as "currentTemp" and payload needs to be a float</p>
    <p style="color: #AD1625;">The entire control is not functional untill this message is received</p>
    <p>The heater status is recalculated when this message recived, or when the user is changing the target temperature.</p>
	<dd>Message example:</dd>
        <pre>
{
    "topic" : "currentTemp",
    "payload" : "22.5"
}
        </pre>
    <h3>Output</h3>
    <p>A message is emited when the status is recalculated (when the user is changing the target temperature or a new input message is received)</p>
    
    <dd>For example:</dd>
    <pre>
{
    "currentTemp":25,
    "targetValue":20,
    "currentSchedule":{
        temp: 19,
        day: "Wednesday",
        time: "00:00"
    },
    "nextSchedule":{
        temp: 22,
        day: "Wednesday",
        time: "06:20"
    },
    "currentHeaterStatus":"off",
    "userTargetValue":20,
    "isUserCustom":true
}
    </pre>       
    <dl class="message-properties">
        <dt>currentTemp<span class="property-type">float</span></dt>
        <dd>The last current temperature received</dd>
    </dl>
    <dl class="message-properties">
        <dt>targetValue<span class="property-type">float</span></dt>
        <dd>Target temperature displyed in front-end. Coul be user custom value, if is changed by the user, or calendar current temperature value set by calendar</dd>
    </dl>
    <dl class="message-properties">
        <dt>currentSchedule<span class="property-type">float</span></dt>
        <dd>Current calendar schedule. The value which would be set if the controller is set on calendar and some aditional information like day of the week and time</dd>
    </dl>
    <dl class="message-properties">
        <dt>nextSchedule<span class="property-type">float</span></dt>
        <dd>Next calendar schedule. The value which will be set if the controller is set on calendar and some aditional information when this will like happen like day of the week and time</dd>
    </dl>
    <dl class="message-properties">
        <dt>currentHeaterStatus<span class="property-type">string (on|off)</span></dt>
        <dd>Calculated the heater status based on the difference between target value and current temperature</dd>
    </dl>
    <dl class="message-properties">
        <dt>userTargetValue<span class="property-type">float</span></dt>
        <dd>The last or current target temperature set by user</dd>
    </dl>
    <dl class="message-properties">
        <dt>isUserCustom<span class="property-type">boolean</span></dt>
        <dd>True if current target temperature is set by the user</dd>
    </dl>
</script>