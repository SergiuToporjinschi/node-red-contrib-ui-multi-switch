<script type="text/html text/x-red" data-template-name="ui-multi-switch">
    <style>
        input.input-control-key, input.input-control-label {
            width: 36%;
            margin-right: 10px;
        }
        .input-control-type {
            width: auto; 
            margin-right: 10px;
        }
        ol#controls-container .control-button-reset{
            margin: 0px; 
            width: 90px
        }
        ol#controls-container label {
            margin: 0px; margin-right: 10px; width: auto
        }
        ol#controls-container{
            min-height: 450px; min-width: 450px;
        }
    </style>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="config.label.name"></span></label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row" id="template-row-group">
        <label for="node-input-group"><i class="fa fa-table"></i> <span data-i18n="config.label.group"></span></label>
        <input type="text" id="node-input-group">
    </div>
    <div class="form-row" id="template-row-size">
        <label><i class="fa fa-object-group"></i> <span data-i18n="config.label.size"></span></label>
        <input type="hidden" id="node-input-width">
        <input type="hidden" id="node-input-height"> 
        <button class="editor-button" id="node-input-size"></button>
    </div>
    <div class="form-row">
        <label style="width:95%; border-bottom: 1px solid #eee;"><span data-i18n="config.label.controls"></label>
    </div>
    <div class="ident"> 
        <div class="form-row" id="template-row-size">
            <ol id="controls-container" style=""></ol>
        </div>
    </div> 
	
</script>

<script type="text/javascript">
    RED.nodes.registerType("ui-multi-switch", {
        category: 'dashboard',
        color: 'rgb( 63, 173, 181)',
        defaults: {
            name: { value: 'Multi switch' },
            group: {
                type: 'ui_group', required: true,
                validate: function (v) {
                    return v && RED.nodes.node(v) && RED.nodes.node(v).type === 'ui_group';
                }
            },
            order: { value: 0 },
            width: {
                value: 8,
                required: true,
                validate: function (v) {
                    var valid = true;
                    var width = v || 0;
                    var currentGroup = $('#node-input-group').val() || this.group;
                    var groupNode = RED.nodes.node(currentGroup);
                    valid = !groupNode || + width <= +groupNode.width;
                    $("#node-input-size").toggleClass("input-error", !valid);
                    return valid;
                }
            },
            height: { value: 3 },
            controls: []
        },
        inputs: 0,
        outputs: 1,
        align: "left",
        icon: "serial.png",
        paletteLabel: "Multi switch",
        label: function () { return this.name || "Multi switch"; },
        oneditprepare: function () {
            $("#node-input-size").elementSizer({
                width: "#node-input-width",
                height: "#node-input-height",
                group: "#node-input-group"
            });
            function resizeRule(container) {
                var newWidth = container.width();
                container.find('.red-ui-typedInput').typedInput("width", newWidth - 100);
            }
            $("#controls-container").editableList({
                addItem: function (container, i, control) {
                    var row = $('<div/>').appendTo(container);
                    var row1Switch = $('<div/>', { style: "margin-top:8px;" }).appendTo(container);
                    var row2Switch = $('<div/>', { style: "margin-top:8px;" }).appendTo(container);
                    var row1Button = $('<div/>', { style: "margin-top:8px; display: none" }).appendTo(container);

                    var selectField = $('<select/>', { class: "input-control-type" }).appendTo(row);
                    selectField.append($("<option></option>").val('switch').text(RED._("node-red-contrib-ui-multi-switch/ui-multi-switch:config.label.switchType")));
                    selectField.append($("<option></option>").val('button').text(RED._("node-red-contrib-ui-multi-switch/ui-multi-switch:config.label.buttonType")));
                    selectField.on('change', function (evt) {
                        if (this.value === 'button') {
                            row1Switch.hide();
                            row2Switch.hide();
                            row1Button.show();
                        } else {
                            row1Switch.show();
                            row2Switch.show();
                            row1Button.hide();
                        }
                        resizeRule(container);
                    });
                    var controlKey = $('<input/>', { id: 'control-key-' + i, class: "input-control-key", type: "text", placeholder: RED._("node-red-contrib-ui-multi-switch/ui-multi-switch:config.label.controlKey") }).appendTo(row);
                    var controlLabel = $('<input/>', { id: 'control-label-' + i, class: "input-control-label", type: "text", placeholder: RED._("node-red-contrib-ui-multi-switch/ui-multi-switch:config.label.controlLabel") }).appendTo(row);

                    var resetWhenClicked = $('<input/>', { id: 'control-button-reset-' + i, class: 'control-button-reset', type: 'checkbox' }).appendTo(row1Button);
                    $('<label/>', { for: 'control-button-reset-' + i }).appendTo(row1Button).text(RED._("node-red-contrib-ui-multi-switch/ui-multi-switch:config.label.buttonReset"));

                    $('<label/>', { for: 'switch-off-value', for: 'control-switch-off-value-' + i, }).appendTo(row1Switch).text(RED._("node-red-contrib-ui-multi-switch/ui-multi-switch:config.label.sendSwitchOffLabel"));
                    var switchOffVal = $('<input/>', { id: 'control-switch-off-value-' + i, class: "input-control-switch-off-value", type: "text" })
                        .appendTo(row1Switch)
                        .typedInput({
                            default: 'bool',
                            types: ['str', 'num', 'bool', 'json', 'bin', 'date', 'flow', 'global'],
                            value: true
                        });

                    $('<label/>', { for: 'switch-on-value', for: 'control-switch-on-value-' + i, }).appendTo(row2Switch).text(RED._("node-red-contrib-ui-multi-switch/ui-multi-switch:config.label.sendSwitchOnLabel"));
                    var switchOnVal = $('<input/>', { id: 'control-switch-on-value-' + i, class: "input-control-switch-on-value", type: "text" })
                        .appendTo(row2Switch)
                        .typedInput({
                            default: 'bool',
                            types: ['str', 'num', 'bool', 'json', 'bin', 'date', 'flow', 'global'],
                            value: true
                        });

                    //Adding default vales
                    if (!control || !control.type) {
                        control = { type: 'switch', onValType: 'bool', onVal: 'true', offValType: 'bool', offVal: 'false' };
                    }

                    //setting existing value
                    selectField.val(control.type);
                    controlKey.val(control.key);
                    controlLabel.val(control.label);
                    if (control.type === 'button') {
                        resetWhenClicked.prop('checked', control.reset);
                    } else if (control.type === 'switch') {
                        switchOffVal.typedInput('type', control.offValType);
                        switchOffVal.typedInput('value', control.offVal);
                        switchOnVal.typedInput('type', control.onValType);
                        switchOnVal.typedInput('value', control.onVal);
                    }
                    selectField.change();
                    resizeRule(container);
                },
                resizeItem: resizeRule,
                removable: true,
                sortable: true
            });

            //Adding existing value
            for (var i = 0; i < this.controls.length; i++) {
                var item = this.controls[i];
                $("#controls-container").editableList('addItem', item);
            }
        },
        oneditsave: function () {
            var node = this;
            var controlList = [];
            var controls = $("#controls-container").editableList('items');
            controls.each(function (i) {
                var item = $(this);
                var type = item.find('.input-control-type').val();
                var key = item.find('.input-control-key').val();
                var label = item.find('.input-control-label').val();
                if (type === 'button') {
                    controlList.push({
                        type: type,
                        key: key,
                        label: label,
                        reset: item.find('.control-button-reset').is(':checked')
                    });
                } else if (type === 'switch') {
                    var offInputType = item.find('.input-control-switch-off-value');
                    var onInputType = item.find('.input-control-switch-on-value');
                    controlList.push({
                        type: type,
                        key: key,
                        label: label,
                        onValType: onInputType.typedInput('type'),
                        onVal: onInputType.typedInput('value'),
                        offValType: offInputType.typedInput('type'),
                        offVal: offInputType.typedInput('value')
                    });
                }
            });
            this.controls = controlList;
        },
        oneditcancel: function () {
        },
        oneditresize: function (size) {
            $("#controls-container").find('.red-ui-typedInput').typedInput("width",size.width-200);
        }
    });
</script>
<script type="text/html text/x-red" data-help-name="ui-multi-switch">
	<p>A dashboard ui interface for multiple checkboxes and buttons; The values of all checkbox are sent to output when the user pushes the button</p>
    <h3>Properties</h3>
    <dl class="message-properties">
		<dt>Min <span class="property-type">integer</span></dt>
		<dd>Minimum vale selectable using slider</dd>
    </dl>
	<dl class="message-properties">
		<dt>Max <span class="property-type">boolean</span></dt>
		<dd>Maximum vale selectable using slider</dd>
    </dl>
    <dl class="message-properties">
		<dt>Step <span class="property-type">integer</span></dt>
		<dd>Step value selectable from slider</dd>
    </dl>
    <dl class="message-properties">
        <dt>Upper threshold<span class="property-type">float</span></dt>
        <dd>Hysteresis upper threshold limit. This value is added to the target temperature to determinate the point of setting the heater to off</dd>
    </dl>
    <dl class="message-properties">
        <dt>Lower threshold<span class="property-type">float</span></dt>
        <dd>Hysteresis Lower threshold limit. This value is added to the target temperature to determinate the point of setting the heater to on</dd>
    </dl>
    <dl class="message-properties">
        <dt>Calendar<span class="property-type">json</span></dt>
        <dd>The calendar which will be apply in automatic mode. Needs to be a valid JSON with float values for temperature.<br>
            Is important to cover the entire interval of 24/7, otherwise will keep the temperature untill next sice or next week day</dd>
        <dd>For example:</dd>
        <pre>
{
    "Monday" : {
        "00:00" : 19,
        "06:20" : 22,
        "08:00" : 19,
        "16:40" : 22,
        "23:59" : 19
    },
    "Tuesday" : {
        "00:00" : 19,
        "06:20" : 22,
        "08:00" : 19,
        "16:40" : 22,
        "23:59" : 19
    }
}
        </pre>
    </dl>    
    <h3>Inputs</h3>
    <p>This controller accepts one main input which has to have topic as "currentTemp" and payload needs to be a float</p>
    <p style="color: #AD1625;">The entire control is not functional untill this message is received</p>
    <p>The heater status is recalculated when this message recived, or when the user is changing the target temperature.</p>
	<dd>Message example:</dd>
        <pre>
{
    "topic" : "currentTemp",
    "payload" : "22.5"
}
        </pre>
    <h3>Output</h3>
    <p>A message is emited when the status is recalculated (when the user is changing the target temperature or a new input message is received)</p>
    
    <dd>For example:</dd>
    <pre>
{
    "currentTemp":25,
    "targetValue":20,
    "currentSchedule":{
        temp: 19,
        day: "Wednesday",
        time: "00:00"
    },
    "nextSchedule":{
        temp: 22,
        day: "Wednesday",
        time: "06:20"
    },
    "currentHeaterStatus":"off",
    "userTargetValue":20,
    "isUserCustom":true
}
    </pre>       
    <dl class="message-properties">
        <dt>currentTemp<span class="property-type">float</span></dt>
        <dd>The last current temperature received</dd>
    </dl>
    <dl class="message-properties">
        <dt>targetValue<span class="property-type">float</span></dt>
        <dd>Target temperature displyed in front-end. Coul be user custom value, if is changed by the user, or calendar current temperature value set by calendar</dd>
    </dl>
    <dl class="message-properties">
        <dt>currentSchedule<span class="property-type">float</span></dt>
        <dd>Current calendar schedule. The value which would be set if the controller is set on calendar and some aditional information like day of the week and time</dd>
    </dl>
    <dl class="message-properties">
        <dt>nextSchedule<span class="property-type">float</span></dt>
        <dd>Next calendar schedule. The value which will be set if the controller is set on calendar and some aditional information when this will like happen like day of the week and time</dd>
    </dl>
    <dl class="message-properties">
        <dt>currentHeaterStatus<span class="property-type">string (on|off)</span></dt>
        <dd>Calculated the heater status based on the difference between target value and current temperature</dd>
    </dl>
    <dl class="message-properties">
        <dt>userTargetValue<span class="property-type">float</span></dt>
        <dd>The last or current target temperature set by user</dd>
    </dl>
    <dl class="message-properties">
        <dt>isUserCustom<span class="property-type">boolean</span></dt>
        <dd>True if current target temperature is set by the user</dd>
    </dl>
</script>